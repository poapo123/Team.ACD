<div class="modal fade" id="export-modal" role="dialog">
    <div class="modal-dialog">
    
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
            <h4 class="modal-title">export</h4>
            <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <form id="export-csv-form" enctype="multipart/form-data">
                    <!--외부접속시 데이터베이스 목록 보여준다-->
                    {% if databases and db_info[0] != 'oracle'%}
                        <label>데이터베이스 선택</label><br>
                        <select name="database_opt" id="database-opt" class="form-control">
                            {% for db in databases %}
                                <option>{{db}}</option>
                            {% endfor %}
                        </select><br>

                    {% endif %}

                    <label>테이블 선택</label><br>
                    <select class="form-control" id="table-opt" name="table_opt">
                        {% for table in tables %}
                            <option>{{table.0}}</option>
                        {% endfor %}
                    </select><br>

                    <label>저장할 파일명</label><br>
                    <input type="text" id="save-file-name" class="form-control" class="save_file_name" placeholder="확장자 제외"><br>
                    <!--progress bar-->
                    <div class="progress" style="width: 100%; ">
                        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                            <span class="progress-bar-label">0%</span>
                        </div>
                    </div><br>
                    <!-- error message -->
                    <div class="alert alert-danger import-error" style="display: none;">
                        <span id="import_error_text"></span>
                    </div>
                    <div class="text-right">
                        <button type="button" id="export-btn" class="btn btn-default">export</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
                    </div>
                
                </form>

                
            </div>
        </div>
    </div>
</div>


<script>
    $("#export-btn").click(function(){
        
        $.ajax({
          type : "post",
          url : "/export_csv/{{id}}",
          data : $("#export-csv-form").serialize(),
          success : (response) => {
            show_progress(response.task_id);
          }
        });
    });
    function show_progress(task_id){
        var url = "/export_csv_progress/"+task_id;
        source = new EventSource(url);

        source.onmessage = function(event) {
            
            var data = event.data.split("&&");
            var state = data[0];
            var progress = data[1];

        
            show_import_error("");
            set_progress(progress+'%');
            if(data.length == 3){
                show_import_error(data[2]);
                source.close();
            }
            if(parseInt(progress) == 100){
                console.log("연결 close");
                
                set_progress_kind("완료");
                source.close();
            }
            

        }
    }

    function set_progress(percent){
        $('.progress-bar').css('width', percent).attr('aria-valuenow',percent);
        $('.progress-bar-label').text(percent);
    }

</script>


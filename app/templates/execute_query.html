{% extends "base.html" %}

{% block stylesheet %}
  {{super()}}
  <style>
    .q-height{
      min-height: 80vh;
    }
    #edit{
      min-height: 30vh;
      height: 30vh;
      max-height: 30vh;
    }
  </style>
  <!--include codemirror css-->
  <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css">
  <link rel="stylesheet" href="http://codemirror.net/addon/hint/show-hint.css">
{% endblock %}

{% block scriptblock %}
<!--include codemirror js -->
<script src="http://codemirror.net/lib/codemirror.js"></script>
<script src="http://codemirror.net/addon/edit/matchbrackets.js"></script>
<script src="http://codemirror.net/addon/edit/continuecomment.js"></script>
<script src="http://codemirror.net/mode/sql/sql.js"></script>
<script src="http://codemirror.net/addon/hint/show-hint.js"></script>
<script src="http://codemirror.net/addon/hint/sql-hint.js"></script>
{% endblock %}


{% block header %}
    
    {% include 'include/_header.html' %}
    <div class="text-right">
      <!--메뉴아이콘-->
      <i class="fa fa-bars fa-2x" data-toggle="drawer" data-target="#drawer-1" aria-hidden="true"></i>
    </div>
    {% include 'include/drawers.html' %}
{% endblock %}

{% block main %}
  <div class="row container">
    <div class="col-md-4 border border-top-0 border-bottom-0 border-left-0 q-height">
      <h2>테이블 리스트</h2>
      <div id="table-list">
        {% include 'include/table_nav.html' %}
      </div>
      
    </div>
    <div class="col-md-8 border border-top-0 border-bottom-0 border-right-0 q-height">
      <div class="border border-top-0 border-left-0 border-right-0">
        <div>
          <a href="{{ url_for('dbide.execute_query', id=id) }}" class="btn btn-primary">전공자</a>
          <a href="{{ url_for('dbide.execute_query_no_major', id=id) }}" class="btn btn-primary">비전공자</a>
        </div>
        <div class="container mt-3">
          <!--<div class="container border" id="edit" contenteditable="true" style="overflow: auto;"></div>-->
          
          <div class="alert alert-info" id="schema-msg">
              데이터베이스 <b class="text-dark">{{dbms_schema}}</b>에 sql질의 실행
          </div>
          <!--sql editor-->
          <div class="border">
            <textarea rows="4"  cols="50" id="edit"></textarea>
          </div>
          
          <div class="mt-2 mb-2 text-right">
            <button type="button" class="btn btn-primary" id="result">결과</button>
            <button type="button" class="btn btn-primary" id="plan">실행 계획</button>
          </div>
        </div>
      </div>
      <div id="alert-box" style="height: 200px; overflow-y: auto;">

      </div>
      <div id="query-result" style="overflow:auto;">
          {% include 'include/query_result.html' %}
        
      </div>
    </div>
  </div>

<script>

$(function(){
  // document.getElementById('result').onclick = (e) => {}
});  


//에디터 초기화
var editor = initSqlEditor();
//자동완성 초기화
initAutoComplete();

$("#result").click(function(){

  $.ajax({
    type : "post",
    url : "/execute_query_result/{{id}}",
    data : {'query' : editor.getValue()},
    success : (response) => {
      $("#alert-box").empty();

      for(var msg of response.msg_list){
          console.log(msg);

          if(msg.error_msg != undefined){
             createMessage(msg.error_msg,'alert-danger');
          }else{
             createMessage(msg,'alert-info');
          }
      }

      if(response.results != undefined){
        updateResult(response.results,response.tables);
      }
      //테이블 자동완성 초기화
      initAutoComplete();
    
    }
  });
});


 
function createMessage(msg,class_name){
  var alert = "";
      alert += "<div class='alert "+class_name+"'>";
      alert += "<button type='button' class='close' data-dismiss='alert'>&times;</button>";
      alert += msg;
      alert += "</div>";

      $("#alert-box").append(alert);
}

//쿼리실행 결과 업데이트
function updateResult(results,tables){
  $("#table-list").empty();
  $("#query-result").empty();

  $("#query-result").append(results);
  $("#table-list").append(tables);

}

function initSqlEditor(){
  var editor = CodeMirror.fromTextArea(document.getElementById('edit'), {
           autofocus: true,
            extraKeys: {
                "Tab": "autocomplete"
            },
            hint: CodeMirror.hint.sql,
            lineNumbers: true,
            mode: 'text/x-sql',
            matchBrackets : true,
            smartIndent: true,
            lineWrapping: true,
    });
    editor.on('keyup', function(editor, event){
            console.log(event.keyCode);
            // enter,backspace,세미콜론,위아래 방향키 아니면 자동완성 
            if(event.keyCode!=13 && event.keyCode != 8 && 
              event.keyCode != 186 && event.keyCode!=38 && event.keyCode != 40 && event.keyCode != 32)
              CodeMirror.commands.autocomplete(editor);
    });

    return editor;

}



function initAutoComplete() {
  var tables = {}
  $.each($("#table-list li"),function(idx,li){
      tables[$(li).text()]=[];
  });

  CodeMirror.commands.autocomplete = function (cmeditor) {

      CodeMirror.showHint(cmeditor, CodeMirror.hint.sql, {

          completeSingle: false,
          tables: tables
      });
  }
}




</script>
{% endblock %}